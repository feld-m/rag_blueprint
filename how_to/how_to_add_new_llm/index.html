<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Add a New LLM - RAG Systems</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Add a New LLM";
        var mkdocs_page_input_path = "how_to/how_to_add_new_llm.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> RAG Systems
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Quickstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../quickstart/quickstart_setup/">Quickstart Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../quickstart/developer_setup/">Local Developement Setup</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">How to</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../how_to_configure/">Configure RAG System</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Add a New LLM</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../how_to_add_new_embedding_model/">Add a New Embedding Model</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../how_to_add_new_vector_store/">Add a New Vector Store</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../how_to_add_new_datasource/">Add a New Datasource</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Evaluation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../evaluation/in_progress/">In progress</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../monitoring/in_progress/">In progress</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Code Docs</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../src/augment/">Augment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../src/embed/">Embed</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../src/evaluate/">Evaluate</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Augmentation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Chainlit</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../src/augmentation/chainlit/feedback_service/">Feedback_service</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/augmentation/chainlit/utils/">Utils</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/augmentation/chainlit/service/">Service</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/augmentation/chainlit/exceptions/">Exceptions</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Langfuse</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../src/augmentation/langfuse/prompt_service/">Prompt_service</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/augmentation/langfuse/client/">Client</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/augmentation/langfuse/dataset_service/">Dataset_service</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Bootstrap</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Configuration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/augmentation/bootstrap/configuration/langfuse_configuration/">Langfuse_configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/augmentation/bootstrap/configuration/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/augmentation/bootstrap/configuration/chainlit_configuration/">Chainlit_configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Components</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/augmentation/bootstrap/initializer/">Initializer</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Components</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Llms</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/augmentation/components/llms/registry/">Registry</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Lite_llm</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Guardrails</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/augmentation/components/guardrails/registry/">Registry</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Basic</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/augmentation/components/guardrails/base_guardrails/">Base_guardrails</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Retrievers</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/augmentation/components/retrievers/registry/">Registry</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Auto</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Basic</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Postprocessors</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/augmentation/components/postprocessors/registry/">Registry</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Colbert_rerank</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Chat_engines</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" >Langfuse</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/augmentation/components/chat_engines/registry/">Registry</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Core</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../src/core/logger/">Logger</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../src/core/base_configuration/">Base_configuration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../src/core/configuration_retrievers/">Configuration_retrievers</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../src/core/base_initializer/">Base_initializer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../src/core/base_factory/">Base_factory</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Embedding</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Embedders</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../src/embedding/embedders/registry/">Registry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/embedding/embedders/base_embedder/">Base_embedder</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Basic</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/embedders/basic/embedder/">Embedder</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Orchestrators</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../src/embedding/orchestrators/registry/">Registry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Basic</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/orchestrators/basic/orchestrator/">Orchestrator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/embedding/orchestrators/base_orchestrator/">Base_orchestrator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Vector_stores</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Chroma</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/chroma/vector_store/">Vector_store</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/chroma/client/">Client</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/chroma/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/chroma/validator/">Validator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/embedding/vector_stores/registry/">Registry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Core</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/core/exceptions/">Exceptions</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/core/validator/">Validator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Pgvector</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/pgvector/vector_store/">Vector_store</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/pgvector/client/">Client</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/pgvector/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/pgvector/validator/">Validator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Qdrant</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/qdrant/vector_store/">Vector_store</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/qdrant/client/">Client</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/qdrant/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/vector_stores/qdrant/validator/">Validator</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Splitters</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../src/embedding/splitters/registry/">Registry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/embedding/splitters/base_splitter/">Base_splitter</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Basic_markdown</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/splitters/basic_markdown/basic_markdown_splitter/">Basic_markdown_splitter</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/splitters/basic_markdown/configuration/">Configuration</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Bootstrap</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Configuration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/bootstrap/configuration/vector_store_configuration/">Vector_store_configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/bootstrap/configuration/embedding_model_configuration/">Embedding_model_configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/bootstrap/configuration/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/bootstrap/configuration/splitting_configuration/">Splitting_configuration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/embedding/bootstrap/initializer/">Initializer</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Embedding_models</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../src/embedding/embedding_models/registry/">Registry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Hugging_face</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/embedding_models/hugging_face/embedding_model/">Embedding_model</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/embedding_models/hugging_face/configuration/">Configuration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Voyage</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/embedding_models/voyage/embedding_model/">Embedding_model</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/embedding_models/voyage/configuration/">Configuration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Openai</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/embedding_models/openai/embedding_model/">Embedding_model</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/embedding/embedding_models/openai/configuration/">Configuration</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Evaluation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Bootstrap</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Configuration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/evaluation/bootstrap/configuration/configuration/">Configuration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/evaluation/bootstrap/initializer/">Initializer</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Evaluators</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../src/evaluation/evaluators/langfuse/">Langfuse</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/evaluation/evaluators/ragas/">Ragas</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Extraction</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Orchestrators</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../src/extraction/orchestrators/base_orchestator/">Base_orchestator</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/extraction/orchestrators/registry/">Registry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Basic</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/extraction/orchestrators/basic/orchestrator/">Orchestrator</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Datasources</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../src/extraction/datasources/pdf/">Pdf</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/extraction/datasources/registry/">Registry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/extraction/datasources/confluence/">Confluence</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/extraction/datasources/core/">Core</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/extraction/datasources/bundestag/">Bundestag</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/extraction/datasources/notion/">Notion</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Bootstrap</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Configuration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../src/extraction/bootstrap/configuration/datasources/">Datasources</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../src/extraction/bootstrap/configuration/configuration/">Configuration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../src/extraction/bootstrap/initializer/">Initializer</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">RAG Systems</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">How to</li>
      <li class="breadcrumb-item active">Add a New LLM</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/feld-m/rag_blueprint/edit/main/docs/how_to/how_to_add_new_llm.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="how-to-add-a-new-llm-implementation">How to Add a New LLM Implementation</h1>
<p>This guide demonstrates how to add support for a new Language Model (LLM) implementation, using OpenAI as an example.</p>
<h2 id="architecture">Architecture</h2>
<p>Large Language Models are mainly responsible for generating the answers based on the user query and retrieved nodes, injected as a context. They are also used in the evaluation process. Additionally, they can be used in various components e.g. <code>AutoRetriever</code>.</p>
<h1 id="implementation">Implementation</h1>
<h2 id="step-1-dependencies">Step 1: Dependencies</h2>
<p>Add the required packages to <code>pyproject.toml</code>:</p>
<pre><code class="language-toml">[project.optional-dependencies]
augmentation = [
    &quot;llama-index-llms-openai&gt;=0.3.25&quot;,
    ...
]
</code></pre>
<h2 id="step-2-llm-enum">Step 2: LLM Enum</h2>
<p>LLM configuration is scoped by provider. Each provider, such as <a href="https://openai.com/">OpenAI</a>, requires its own Pydantic configuration class. Begin by assigning a meaningful name to the new provider in the <code>LLMProviderName</code> enumeration in <a href="https://github.com/feld-m/rag_blueprint/blob/main/src/augmentation/bootstrap/configuration/components/llm_configuration.py">llm_configuration.py</a>:</p>
<pre><code class="language-py">class LLMProviderName(str, Enum):
    ...
    OPENAI = &quot;openai&quot;
</code></pre>
<h2 id="step-3-llm-configuration-and-secrets">Step 3: LLM Configuration And Secrets</h2>
<p>Create a new directory <code>src/augmentation/components/llms/openai</code> and create a <code>configuration.py</code> file in it. This configuration file will contain necessary fields and secrets for setup.</p>
<pre><code class="language-py">from typing import Literal
from pydantic import ConfigDict, Field, SecretStr
from augmentation.bootstrap.configuration.components.llm_configuration import (
    LLMConfiguration,
    LLMProviderName,
)
from core.base_configuration import BaseSecrets


class OpenAILLMConfiguration(LLMConfiguration):
    class Secrets(BaseSecrets):
        model_config = ConfigDict(
            env_file_encoding=&quot;utf-8&quot;,
            env_prefix=&quot;RAG__LLMS__OPENAI__&quot;,
            env_nested_delimiter=&quot;__&quot;,
            extra=&quot;ignore&quot;,
        )

        api_key: SecretStr = Field(
            ..., description=&quot;API key for the model provider.&quot;
        )

    provider: Literal[LLMProviderName.OPENAI] = Field(
        ..., description=&quot;The name of the language model provider.&quot;
    )
    secrets: Secrets = Field(
        None, description=&quot;The secrets for the language model.&quot;
    )
</code></pre>
<p>The first part is to create a configuration that extends <code>LLMConfiguration</code>. <code>provider</code> field constraints the value to <code>LLMProviderName.OPENAI</code>, which serves as an indicator for pydantic validator. The <code>Secrets</code> inner class defines secret fields that will be present in the environment secret file under the <code>RAG__LLMS__OPENAI__</code> prefix. Add the corresponding environment variables to <code>configurations/secrets.{environment}.env</code>:</p>
<pre><code class="language-sh">RAG__LLMS__OPENAI__API_KEY=&lt;openai_api_key&gt;
</code></pre>
<h2 id="step-4-llm-implementation">Step 4: LLM Implementation</h2>
<p>In the <code>llm.py</code> file, create singleton LLM factory. It provides a framework, where LLM can be retrieved through <code>OpenaAILLMFactory</code> and is initialized only once per runtime, saving up the memory (e.g. in cases of small in-memory LLMs). To do so, define expected <code>_configuration_class</code> type and provide <code>_create_instance</code> implementation using <code>llamaindex</code>.</p>
<pre><code class="language-py">from typing import Type
from llama_index.llms.openai import OpenAI
from augmentation.components.llms.openai.configuration import (
    OpenAILLMConfiguration,
)
from core import SingletonFactory


class OpenaAILLMFactory(SingletonFactory):
    _configuration_class: Type = OpenAILLMConfiguration

    @classmethod
    def _create_instance(cls, configuration: OpenAILLMConfiguration) -&gt; OpenAI:
        return OpenAI(
            api_key=configuration.secrets.api_key.get_secret_value(),
            model=configuration.name,
            max_tokens=configuration.max_tokens,
            max_retries=configuration.max_retries,
        )
</code></pre>
<h2 id="step-5-llm-output-extractor">Step 5: LLM Output Extractor</h2>
<p>Human feedback feature between Chainlit and Langfuse require extraction of information about LLM response. Each provider returns the differently structured output dictionary. Therefore, we need to implement an extractor of required fields. Create <code>output_extractor.py</code>:</p>
<pre><code class="language-py">from typing import Type
from langfuse.api.resources.commons.types.trace_with_details import (
    TraceWithDetails,
)
from augmentation.components.llms.core.base_output_extractor import (
    BaseLlamaindexLLMOutputExtractor,
)
from augmentation.components.llms.openai.configuration import (
    OpenAILLMConfiguration,
)
from core.base_factory import Factory


class OpenAILlamaindexLLMOutputExtractor(BaseLlamaindexLLMOutputExtractor):

    def get_text(self, trace: TraceWithDetails) -&gt; str:
        return trace.output[&quot;blocks&quot;][0][&quot;text&quot;]

    def get_generated_by_model(self, trace: TraceWithDetails) -&gt; str:
        return self.configuration.name
</code></pre>
<p>Implemented interface <code>BaseLlamaindexLLMOutputExtractor</code>, provide sufficient extractor for <code>ChainlitFeedbackService</code> purposes. Now just add correspodning factory:</p>
<pre><code class="language-py">class OpenAILlamaindexLLMOutputExtractorFactory(Factory):
    _configuration_class: Type = OpenAILLMConfiguration

    @classmethod
    def _create_instance(
        cls, configuration: OpenAILLMConfiguration
    ) -&gt; OpenAILlamaindexLLMOutputExtractor:
        return OpenAILlamaindexLLMOutputExtractor(configuration)
</code></pre>
<h2 id="step-6-llm-integration">Step 6: LLM Integration</h2>
<p>Create an <code>__init__.py</code> file as follows:</p>
<pre><code class="language-py">from augmentation.bootstrap.configuration.components.llm_configuration import (
    LLMConfigurationRegistry,
    LLMProviderName,
)
from augmentation.components.llms.openai.configuration import (
    OpenAILLMConfiguration,
)
from augmentation.components.llms.openai.llm import OpenaAILLMFactory
from augmentation.components.llms.openai.output_extractor import (
    OpenAILlamaindexLLMOutputExtractorFactory,
)
from augmentation.components.llms.registry import (
    LlamaindexLLMOutputExtractorRegistry,
    LLMRegistry,
)


def register() -&gt; None:
    LLMRegistry.register(LLMProviderName.OPENAI, OpenaAILLMFactory)
    LLMConfigurationRegistry.register(
        LLMProviderName.OPENAI, OpenAILLMConfiguration
    )
    LlamaindexLLMOutputExtractorRegistry.register(
        LLMProviderName.OPENAI, OpenAILlamaindexLLMOutputExtractorFactory
    )
</code></pre>
<p>The initialization file includes a <code>register()</code> method responsible for registering our configuration, output extractor and LLM factories. Registries are used to dynamically inform the system about available implementations. This way, with the following OpenAI configuration in <code>configurations/configuration.{environment}.json</code> file:</p>
<pre><code class="language-json">&quot;augmentation&quot;:
{
    &quot;chat_engine&quot;:
    {
        &quot;llm&quot;: {
            &quot;provider&quot;: &quot;openai&quot;,
            &quot;name&quot;: &quot;gpt-4o&quot;,     // any model name compatible with OpenAI API

        }
    }
    ...
}
</code></pre>
<p><strong><em>Note</em></strong>: You can use any <code>name</code> exposed by OpenAI</p>
<p>We can dynamically retrieve the corresponding LLM implementation by using the name specified in the configuration:</p>
<pre><code class="language-py">llm_config = read_llm_from_config()
llm_model = LLMRegistry.get(llm_config.name).create(llm_config)
</code></pre>
<p>This mechanism is later used by the chat engine to initialize the llm defined in the configuration. These steps conclude the implementation, resulting in the following file structure:</p>
<pre><code>src/
└── augmentation/
    └── components/
        └── llms/
            └── openai/
                ├── __init__.py
                ├── configuration.py
                ├── llm.py
                └── output_extractor.py
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../how_to_configure/" class="btn btn-neutral float-left" title="Configure RAG System"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../how_to_add_new_embedding_model/" class="btn btn-neutral float-right" title="Add a New Embedding Model">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/feld-m/rag_blueprint/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../how_to_configure/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../how_to_add_new_embedding_model/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
