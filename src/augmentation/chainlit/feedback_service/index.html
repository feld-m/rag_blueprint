<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>Feedback_service - RAG Systems</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Feedback_service";
        var mkdocs_page_input_path = "src/augmentation/chainlit/feedback_service.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../.." class="icon icon-home"> RAG Systems
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Quickstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/quickstart_setup/">Quickstart Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/developer_setup/">Local Developement Setup</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">How to</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../how_to/how_to_configure/">Configure RAG System</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../how_to/how_to_add_new_llm/">Add a New LLM</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../how_to/how_to_add_new_embedding_model/">Add a New Embedding Model</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../how_to/how_to_add_new_vector_store/">Add a New Vector Store</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../how_to/how_to_add_new_datasource/">Add a New Datasource</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Evaluation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../evaluation/in_progress/">In progress</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../monitoring/in_progress/">In progress</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Code Docs</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../../augment/">Augment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../embed/">Embed</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../evaluate/">Evaluate</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Augmentation</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" >Bootstrap</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Configuration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../bootstrap/configuration/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../bootstrap/configuration/temporal_domain_config/">Temporal_domain_config</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../bootstrap/configuration/chainlit_configuration/">Chainlit_configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Components</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../bootstrap/configuration/langfuse_configuration/">Langfuse_configuration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../bootstrap/initializer/">Initializer</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Components</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Postprocessors</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" >Colbert_rerank</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Hybrid_filter</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../components/postprocessors/registry/">Registry</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Chat_engines</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" >Langfuse</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../components/chat_engines/registry/">Registry</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Retrievers</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../components/retrievers/query_rewriter/">Query_rewriter</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../components/retrievers/query_rewriting_retriever/">Query_rewriting_retriever</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Basic</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Auto</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../components/retrievers/registry/">Registry</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Dynamic_temporal</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Llms</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../components/llms/registry/">Registry</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Lite_llm</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Guardrails</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../components/guardrails/base_guardrails/">Base_guardrails</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" >Basic</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../components/guardrails/registry/">Registry</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Langfuse</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../langfuse/client/">Client</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../langfuse/dataset_service/">Dataset_service</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../langfuse/prompt_service/">Prompt_service</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" >Chainlit</a>
    <ul class="current">
                <li class="toctree-l3 current"><a class="reference internal current" href="#">Feedback_service</a>
    <ul class="current">
    <li class="toctree-l4"><a class="reference internal" href="#feedback_service_1">Feedback_service</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#src.augmentation.chainlit.feedback_service">feedback_service</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#src.augmentation.chainlit.feedback_service.ChainlitFeedbackService">ChainlitFeedbackService</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#src.augmentation.chainlit.feedback_service.ChainlitFeedbackServiceFactory">ChainlitFeedbackServiceFactory</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../utils/">Utils</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../service/">Service</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../exceptions/">Exceptions</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Core</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../core/logger/">Logger</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../core/base_factory/">Base_factory</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../core/configuration_retrievers/">Configuration_retrievers</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../core/base_configuration/">Base_configuration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../core/base_initializer/">Base_initializer</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Embedding</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Vector_stores</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Qdrant</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/qdrant/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/qdrant/vector_store/">Vector_store</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/qdrant/validator/">Validator</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/qdrant/client/">Client</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Chroma</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/chroma/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/chroma/vector_store/">Vector_store</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/chroma/validator/">Validator</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/chroma/client/">Client</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Core</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/core/validator/">Validator</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/core/exceptions/">Exceptions</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../embedding/vector_stores/registry/">Registry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Pgvector</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/pgvector/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/pgvector/vector_store/">Vector_store</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/pgvector/validator/">Validator</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/vector_stores/pgvector/client/">Client</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Bootstrap</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Configuration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/bootstrap/configuration/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/bootstrap/configuration/vector_store_configuration/">Vector_store_configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/bootstrap/configuration/splitting_configuration/">Splitting_configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/bootstrap/configuration/embedding_model_configuration/">Embedding_model_configuration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../embedding/bootstrap/initializer/">Initializer</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Embedders</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../embedding/embedders/base_embedder/">Base_embedder</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Basic</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/embedders/basic/embedder/">Embedder</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../embedding/embedders/registry/">Registry</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Orchestrators</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Basic</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/orchestrators/basic/orchestrator/">Orchestrator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../embedding/orchestrators/registry/">Registry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../embedding/orchestrators/base_orchestrator/">Base_orchestrator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Embedding_models</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Hugging_face</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/embedding_models/hugging_face/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/embedding_models/hugging_face/embedding_model/">Embedding_model</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Openai</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/embedding_models/openai/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/embedding_models/openai/embedding_model/">Embedding_model</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Voyage</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/embedding_models/voyage/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/embedding_models/voyage/embedding_model/">Embedding_model</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../embedding/embedding_models/registry/">Registry</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Splitters</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Basic_markdown</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/splitters/basic_markdown/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../embedding/splitters/basic_markdown/basic_markdown_splitter/">Basic_markdown_splitter</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../embedding/splitters/base_splitter/">Base_splitter</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../embedding/splitters/registry/">Registry</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Evaluation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Bootstrap</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Configuration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../evaluation/bootstrap/configuration/configuration/">Configuration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../evaluation/bootstrap/initializer/">Initializer</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Evaluators</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../evaluation/evaluators/langfuse/">Langfuse</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../evaluation/evaluators/ragas/">Ragas</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Extraction</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Bootstrap</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Configuration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../extraction/bootstrap/configuration/configuration/">Configuration</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../../extraction/bootstrap/configuration/datasources/">Datasources</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../extraction/bootstrap/initializer/">Initializer</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Orchestrators</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../extraction/orchestrators/base_orchestator/">Base_orchestator</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Basic</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../../extraction/orchestrators/basic/orchestrator/">Orchestrator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../extraction/orchestrators/registry/">Registry</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Datasources</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../extraction/datasources/pdf/">Pdf</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../extraction/datasources/confluence/">Confluence</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../extraction/datasources/bundestag/">Bundestag</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../extraction/datasources/core/">Core</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../extraction/datasources/notion/">Notion</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../extraction/datasources/registry/">Registry</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../..">RAG Systems</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Code Docs</li>
          <li class="breadcrumb-item">Augmentation</li>
          <li class="breadcrumb-item">Chainlit</li>
      <li class="breadcrumb-item active">Feedback_service</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/feld-m/rag_blueprint/edit/main/docs/src/augmentation/chainlit/feedback_service.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="feedback_service">Feedback_service</h1>
<p>This module contains functionality related to the the <code>feedback_service</code> module for <code>augmentation.chainlit</code>.</p>
<h2 id="feedback_service_1">Feedback_service</h2>


<div class="doc doc-object doc-module">



<a id="src.augmentation.chainlit.feedback_service"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="src.augmentation.chainlit.feedback_service.ChainlitFeedbackService" class="doc doc-heading">
            <code>ChainlitFeedbackService</code>


</h2>


    <div class="doc doc-contents ">



        <p>Service for handling Chainlit feedback and Langfuse integration.</p>
<p>This service processes user feedback from the Chainlit UI and integrates it with
Langfuse for tracking and analysis. It associates feedback with traces in Langfuse,
saves positive feedback examples to datasets, and provides mechanisms for retrieving
relevant trace information.</p>
<p>The service tracks feedback scores, comments, and message content, allowing for
detailed analytics in the Langfuse UI and quality improvement of responses over time.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Attributes:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>SCORE_NAME</code></b>
              â€“
              <div class="doc-md-description">
                <p>The standardized name used for feedback scores in Langfuse.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>






              <details class="quote">
                <summary>Source code in <code>src/augmentation/chainlit/feedback_service.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ChainlitFeedbackService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Service for handling Chainlit feedback and Langfuse integration.</span>

<span class="sd">    This service processes user feedback from the Chainlit UI and integrates it with</span>
<span class="sd">    Langfuse for tracking and analysis. It associates feedback with traces in Langfuse,</span>
<span class="sd">    saves positive feedback examples to datasets, and provides mechanisms for retrieving</span>
<span class="sd">    relevant trace information.</span>

<span class="sd">    The service tracks feedback scores, comments, and message content, allowing for</span>
<span class="sd">    detailed analytics in the Langfuse UI and quality improvement of responses over time.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        SCORE_NAME: The standardized name used for feedback scores in Langfuse.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SCORE_NAME</span> <span class="o">=</span> <span class="s2">&quot;User Feedback&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">langfuse_dataset_service</span><span class="p">:</span> <span class="n">LangfuseDatasetService</span><span class="p">,</span>
        <span class="n">langfuse_client</span><span class="p">:</span> <span class="n">Langfuse</span><span class="p">,</span>
        <span class="n">feedback_dataset</span><span class="p">:</span> <span class="n">LangfuseDatasetConfiguration</span><span class="p">,</span>
        <span class="n">chainlit_tag_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">LoggerConfiguration</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the ChainlitFeedbackService. Creates the feedback dataset if it doesn&#39;t exist.</span>

<span class="sd">        Args:</span>
<span class="sd">            langfuse_dataset_service: Service for creating and managing Langfuse datasets.</span>
<span class="sd">            langfuse_client: Client for interacting with the Langfuse API.</span>
<span class="sd">            feedback_dataset: Configuration for the dataset where positive feedback is stored.</span>
<span class="sd">            chainlit_tag_format: Format string for generating tags to retrieve traces by message ID.</span>
<span class="sd">            logger: Logger instance for recording service activities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_dataset_service</span> <span class="o">=</span> <span class="n">langfuse_dataset_service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_client</span> <span class="o">=</span> <span class="n">langfuse_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feedback_dataset</span> <span class="o">=</span> <span class="n">feedback_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chainlit_tag_format</span> <span class="o">=</span> <span class="n">chainlit_tag_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_dataset_service</span><span class="o">.</span><span class="n">create_if_does_not_exist</span><span class="p">(</span><span class="n">feedback_dataset</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upsert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedback</span><span class="p">:</span> <span class="n">Feedback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process and store Chainlit feedback in Langfuse.</span>

<span class="sd">        Takes a feedback object from Chainlit, associates it with the appropriate trace in Langfuse,</span>
<span class="sd">        and performs two main actions:</span>
<span class="sd">        1. Records the feedback as a score on the trace</span>
<span class="sd">        2. For positive feedback, saves the trace data to the feedback dataset for future model training</span>

<span class="sd">        Args:</span>
<span class="sd">            feedback: Chainlit Feedback object containing user feedback value, optional comment,</span>
<span class="sd">                     and reference to the message being rated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if feedback was successfully processed and stored, False if an error occurred.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_trace</span><span class="p">(</span><span class="n">feedback</span><span class="o">.</span><span class="n">forId</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_positive</span><span class="p">(</span><span class="n">feedback</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Uploading trace </span><span class="si">{</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> to dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback_dataset</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_upload_trace_to_dataset</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_client</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
                <span class="n">trace_id</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">ChainlitFeedbackService</span><span class="o">.</span><span class="n">SCORE_NAME</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">feedback</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">comment</span><span class="o">=</span><span class="n">feedback</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Upserted feedback for </span><span class="si">{</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> trace with value </span><span class="si">{</span><span class="n">feedback</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace_id</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">trace</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to upsert feedback for </span><span class="si">{</span><span class="n">trace_id</span><span class="si">}</span><span class="s2"> trace: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TraceWithDetails</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve Langfuse trace associated with a Chainlit message ID.</span>

<span class="sd">        Uses the configured tag format to locate the trace related to a specific</span>
<span class="sd">        Chainlit message.</span>

<span class="sd">        Args:</span>
<span class="sd">            message_id: The unique identifier of the Chainlit message.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TraceWithDetails: The complete trace data for the message.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TraceNotFoundException: If no trace exists with the tag for this message ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_client</span><span class="o">.</span><span class="n">fetch_traces</span><span class="p">(</span>
            <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chainlit_tag_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TraceNotFoundException</span><span class="p">(</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trace</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_upload_trace_to_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="n">TraceWithDetails</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a trace to the feedback dataset for model improvement.</span>

<span class="sd">        Extracts relevant data from the trace including input query, retrieved nodes,</span>
<span class="sd">        templating information, and the final response, then creates a dataset item</span>
<span class="sd">        that can be used for model evaluation or fine-tuning.</span>

<span class="sd">        Args:</span>
<span class="sd">            trace: The trace containing the complete interaction details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retrieve_observation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_last_retrieve_observation</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">last_templating_observation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_last_templating_observation</span><span class="p">(</span>
            <span class="n">trace</span>
        <span class="p">)</span>
        <span class="n">output_generation_observation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_pre_last_generation_observation</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_client</span><span class="o">.</span><span class="n">create_dataset_item</span><span class="p">(</span>
            <span class="n">dataset_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback_dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;query_str&quot;</span><span class="p">:</span> <span class="n">trace</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="n">retrieve_observation</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">),</span>
                <span class="s2">&quot;templating&quot;</span><span class="p">:</span> <span class="n">last_templating_observation</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">expected_output</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">output_generation_observation</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;blocks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span>
                    <span class="s2">&quot;text&quot;</span>
                <span class="p">],</span>
            <span class="p">},</span>
            <span class="n">source_trace_id</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;generated_by&quot;</span><span class="p">:</span> <span class="n">output_generation_observation</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_last_retrieve_observation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="n">TraceWithDetails</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObservationsView</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the most recent retrieval observation from a trace.</span>

<span class="sd">        Retrieves information about the knowledge retrieval step in the RAG pipeline,</span>
<span class="sd">        including which nodes/documents were retrieved.</span>

<span class="sd">        Args:</span>
<span class="sd">            trace: The trace containing all observations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ObservationsView: The most recent retrieval observation, containing retrieved nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retrieve_observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_client</span><span class="o">.</span><span class="n">fetch_observations</span><span class="p">(</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;retrieve&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">retrieve_observations</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">createdAt</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_last_templating_observation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="n">TraceWithDetails</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObservationsView</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the most recent templating observation from a trace.</span>

<span class="sd">        Retrieves information about how the prompt was constructed before being</span>
<span class="sd">        sent to the language model.</span>

<span class="sd">        Args:</span>
<span class="sd">            trace: The trace containing all observations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ObservationsView: The most recent templating observation, containing prompt construction details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">templating_observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_client</span><span class="o">.</span><span class="n">fetch_observations</span><span class="p">(</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;templating&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">templating_observations</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">createdAt</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_pre_last_generation_observation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="n">TraceWithDetails</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObservationsView</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the second most recent output observation from a trace.</span>

<span class="sd">        Retrieves information about the output generated by the language model,</span>
<span class="sd">        specifically the one before the last one.</span>

<span class="sd">        Args:</span>
<span class="sd">            trace: The trace containing all observations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ObservationsView: The second most recent output observation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_client</span><span class="o">.</span><span class="n">fetch_observations</span><span class="p">(</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;GENERATION&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">output_observations</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">createdAt</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_positive</span><span class="p">(</span><span class="n">feedback</span><span class="p">:</span> <span class="n">Feedback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if the feedback is positive.</span>

<span class="sd">        Classifies feedback as positive if its numeric value is greater than zero.</span>
<span class="sd">        Positive feedback is used to identify high-quality examples for the dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            feedback: The feedback object containing the user&#39;s rating.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the feedback value is positive (greater than 0), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">feedback</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="src.augmentation.chainlit.feedback_service.ChainlitFeedbackService.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">langfuse_dataset_service</span><span class="p">,</span> <span class="n">langfuse_client</span><span class="p">,</span> <span class="n">feedback_dataset</span><span class="p">,</span> <span class="n">chainlit_tag_format</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">LoggerConfiguration</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the ChainlitFeedbackService. Creates the feedback dataset if it doesn't exist.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>langfuse_dataset_service</code></b>
                  (<code><span title="augmentation.langfuse.dataset_service.LangfuseDatasetService">LangfuseDatasetService</span></code>)
              â€“
              <div class="doc-md-description">
                <p>Service for creating and managing Langfuse datasets.</p>
              </div>
            </li>
            <li>
              <b><code>langfuse_client</code></b>
                  (<code><span title="langfuse.Langfuse">Langfuse</span></code>)
              â€“
              <div class="doc-md-description">
                <p>Client for interacting with the Langfuse API.</p>
              </div>
            </li>
            <li>
              <b><code>feedback_dataset</code></b>
                  (<code><span title="augmentation.bootstrap.configuration.langfuse_configuration.LangfuseDatasetConfiguration">LangfuseDatasetConfiguration</span></code>)
              â€“
              <div class="doc-md-description">
                <p>Configuration for the dataset where positive feedback is stored.</p>
              </div>
            </li>
            <li>
              <b><code>chainlit_tag_format</code></b>
                  (<code><span title="str">str</span></code>)
              â€“
              <div class="doc-md-description">
                <p>Format string for generating tags to retrieve traces by message ID.</p>
              </div>
            </li>
            <li>
              <b><code>logger</code></b>
                  (<code><span title="logging.Logger">Logger</span></code>, default:
                      <code><span title="core.logger.LoggerConfiguration.get_logger">get_logger</span>(<span title="__name__">__name__</span>)</code>
)
              â€“
              <div class="doc-md-description">
                <p>Logger instance for recording service activities.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/augmentation/chainlit/feedback_service.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">langfuse_dataset_service</span><span class="p">:</span> <span class="n">LangfuseDatasetService</span><span class="p">,</span>
    <span class="n">langfuse_client</span><span class="p">:</span> <span class="n">Langfuse</span><span class="p">,</span>
    <span class="n">feedback_dataset</span><span class="p">:</span> <span class="n">LangfuseDatasetConfiguration</span><span class="p">,</span>
    <span class="n">chainlit_tag_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">LoggerConfiguration</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the ChainlitFeedbackService. Creates the feedback dataset if it doesn&#39;t exist.</span>

<span class="sd">    Args:</span>
<span class="sd">        langfuse_dataset_service: Service for creating and managing Langfuse datasets.</span>
<span class="sd">        langfuse_client: Client for interacting with the Langfuse API.</span>
<span class="sd">        feedback_dataset: Configuration for the dataset where positive feedback is stored.</span>
<span class="sd">        chainlit_tag_format: Format string for generating tags to retrieve traces by message ID.</span>
<span class="sd">        logger: Logger instance for recording service activities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_dataset_service</span> <span class="o">=</span> <span class="n">langfuse_dataset_service</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_client</span> <span class="o">=</span> <span class="n">langfuse_client</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feedback_dataset</span> <span class="o">=</span> <span class="n">feedback_dataset</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">chainlit_tag_format</span> <span class="o">=</span> <span class="n">chainlit_tag_format</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_dataset_service</span><span class="o">.</span><span class="n">create_if_does_not_exist</span><span class="p">(</span><span class="n">feedback_dataset</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="src.augmentation.chainlit.feedback_service.ChainlitFeedbackService.upsert" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">upsert</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Process and store Chainlit feedback in Langfuse.</p>
<p>Takes a feedback object from Chainlit, associates it with the appropriate trace in Langfuse,
and performs two main actions:
1. Records the feedback as a score on the trace
2. For positive feedback, saves the trace data to the feedback dataset for future model training</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>feedback</code></b>
                  (<code><span title="chainlit.types.Feedback">Feedback</span></code>)
              â€“
              <div class="doc-md-description">
                <p>Chainlit Feedback object containing user feedback value, optional comment,
     and reference to the message being rated.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>bool</code></b>(                  <code><span title="bool">bool</span></code>
)              â€“
              <div class="doc-md-description">
                <p>True if feedback was successfully processed and stored, False if an error occurred.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/augmentation/chainlit/feedback_service.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upsert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedback</span><span class="p">:</span> <span class="n">Feedback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process and store Chainlit feedback in Langfuse.</span>

<span class="sd">    Takes a feedback object from Chainlit, associates it with the appropriate trace in Langfuse,</span>
<span class="sd">    and performs two main actions:</span>
<span class="sd">    1. Records the feedback as a score on the trace</span>
<span class="sd">    2. For positive feedback, saves the trace data to the feedback dataset for future model training</span>

<span class="sd">    Args:</span>
<span class="sd">        feedback: Chainlit Feedback object containing user feedback value, optional comment,</span>
<span class="sd">                 and reference to the message being rated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if feedback was successfully processed and stored, False if an error occurred.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_trace</span><span class="p">(</span><span class="n">feedback</span><span class="o">.</span><span class="n">forId</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_positive</span><span class="p">(</span><span class="n">feedback</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Uploading trace </span><span class="si">{</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> to dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback_dataset</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_upload_trace_to_dataset</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">langfuse_client</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">ChainlitFeedbackService</span><span class="o">.</span><span class="n">SCORE_NAME</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">feedback</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">feedback</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Upserted feedback for </span><span class="si">{</span><span class="n">trace</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> trace with value </span><span class="si">{</span><span class="n">feedback</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">trace_id</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">trace</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to upsert feedback for </span><span class="si">{</span><span class="n">trace_id</span><span class="si">}</span><span class="s2"> trace: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>


</div>

<div class="doc doc-object doc-class">



<h2 id="src.augmentation.chainlit.feedback_service.ChainlitFeedbackServiceFactory" class="doc doc-heading">
            <code>ChainlitFeedbackServiceFactory</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="core.Factory">Factory</span></code></p>



        <p>Factory for creating ChainlitFeedbackService instances.</p>
<p>This factory creates properly configured ChainlitFeedbackService instances using
the application configuration. It handles initializing dependencies like the
Langfuse client and dataset service.</p>







              <details class="quote">
                <summary>Source code in <code>src/augmentation/chainlit/feedback_service.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ChainlitFeedbackServiceFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating ChainlitFeedbackService instances.</span>

<span class="sd">    This factory creates properly configured ChainlitFeedbackService instances using</span>
<span class="sd">    the application configuration. It handles initializing dependencies like the</span>
<span class="sd">    Langfuse client and dataset service.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_configuration_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">_AugmentationConfiguration</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_instance</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">_AugmentationConfiguration</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChainlitFeedbackService</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new ChainlitFeedbackService instance.</span>

<span class="sd">        Creates and configures a feedback service with the proper Langfuse client,</span>
<span class="sd">        dataset service, and configuration settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            configuration: Application configuration containing Langfuse settings.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChainlitFeedbackService: A fully configured feedback service instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">langfuse_client</span> <span class="o">=</span> <span class="n">LangfuseClientFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">langfuse</span><span class="p">)</span>
        <span class="n">langfuse_dataset_service</span> <span class="o">=</span> <span class="n">LangfuseDatasetServiceFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">.</span><span class="n">langfuse</span>
        <span class="p">)</span>
        <span class="n">feedback_dataset</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">langfuse</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">feedback_dataset</span>
        <span class="n">chainlit_tag_format</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">langfuse</span><span class="o">.</span><span class="n">chainlit_tag_format</span>
        <span class="k">return</span> <span class="n">ChainlitFeedbackService</span><span class="p">(</span>
            <span class="n">langfuse_client</span><span class="o">=</span><span class="n">langfuse_client</span><span class="p">,</span>
            <span class="n">langfuse_dataset_service</span><span class="o">=</span><span class="n">langfuse_dataset_service</span><span class="p">,</span>
            <span class="n">feedback_dataset</span><span class="o">=</span><span class="n">feedback_dataset</span><span class="p">,</span>
            <span class="n">chainlit_tag_format</span><span class="o">=</span><span class="n">chainlit_tag_format</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>


</div>




  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../langfuse/prompt_service/" class="btn btn-neutral float-left" title="Prompt_service"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../utils/" class="btn btn-neutral float-right" title="Utils">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/feld-m/rag_blueprint/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../langfuse/prompt_service/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../utils/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../..";</script>
    <script src="../../../../js/theme_extra.js"></script>
    <script src="../../../../js/theme.js"></script>
      <script src="../../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
